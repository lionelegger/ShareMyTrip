as=angular.module("myApp",["ngRoute"]),as.controller("MainCtrl",function(t,e,n,o){t.getCurrentUser=function(){e.get("users/current.json").success(function(e){void 0!==e.user&&(t.currentUserId=e.user.id,t.currentUserEmail=e.user.email,t.currentUserPassword=e.user.password,t.currentUserFirstname=e.user.first_name,t.currentUserLastname=e.user.last_name)}).error(function(){t.currentUserId="user undefined"})},t.getCurrentUser(),t.logout=function(){e.get("Users/logout")},t.userToAdd={},t.addUser=function(){e.post("Users/add",t.userToAdd).success(function(){t.userToAdd={},document.location="trips"}).error(function(){console.log("Something went wrong during user registration")})}}),as.controller("TripsCtrl",function(t,e,n){t.loadTrips=function(){n.get("trips.json").success(function(e){t.trips=e.trips,$(".modal-backdrop").hide()}).error(function(){console.log("Something went wrong during load Trips")})},t.loadTrips(),t.loadTrip=function(e){o=!1,n.get("trips/"+e+".json").success(function(e){t.trip=e.trip}).error(function(){console.log("Something went wrong during load Trip")})},t.addTrip=function(){t.tripToAdd={},t.welcomeMsg=!1,t.tripToAdd.name=$("#add_tripName").val(),$("#add_date_start").val()&&(t.tripToAdd.date_start=$("#add_date_start").val()+" 12:00:00"),$("#add_date_end").val()&&(t.tripToAdd.date_end=$("#add_date_end").val()+" 12:00:00"),t.tripToAdd.currency=$("#add_currency option:selected").val(),n.post("Trips/add.json",t.tripToAdd).success(function(e){t.tripToAdd={},t.loadTrips()}).error(function(){console.log("Something went wrong during add Trip")})},t.editTrip=function(e){t.btnPressed=!1,t.buttonTxt="Delete",$(".modal .form-message").empty(),e?t.loadTrip(e):(t.trip={},t.trips.trip={})},t.editParticipants=function(e){t.loadTrip(e),t.getTripUsers(e)},t.saveTrip=function(e){t.trip.date_start=$("#date_start").val(),t.trip.date_end=$("#date_end").val(),t.trip.currency=$("#currency option:selected").val(),n.post("Trips/edit/"+e,t.trip).success(function(){t.loadTrips()}).error(function(){console.log("Something went wrong during save Trip")})},t.buttonTxt="Delete",t.deleteConfirm=function(e){t.btnPressed?(t.btnPressed=!1,$("#tripEdit").modal("toggle"),t.deleteTrip(e),t.buttonTxt="Delete trip"):(t.btnPressed=!0,t.buttonTxt="Are you sure?")},t.buttonUserTxt="Delete",t.deleteUserConfirm=function(e){t.btnUserPressed?(t.btnUserPressed=!1,t.tripDeleteUser(e),t.buttonUserTxt="Delete trip"):(t.btnUserPressed=!0,t.buttonUserTxt="Are you sure?")},t.deleteTrip=function(e){n["delete"]("Trips/delete/"+e).success(function(){t.loadTrips()}).error(function(){console.log("Something went wrong during save Trip")})},t.getTripUsers=function(e){n.get("trips/"+e+".json").success(function(e){t.trips.trip=e.trip}).error(function(){console.log("Something went wrong during load Trip")})};var o=!1;t.tripDeleteUser=function(t){return console.log("secondPress = "+o),o===!1?($("#tripDeleteUser-"+t).addClass("btn-danger").removeClass("btn-default"),$("#tripDeleteUser-"+t).text("Are you sure?"),void(o=!0)):void(o===!0&&n["delete"]("TripsUsers/delete/"+t+".json").success(function(){$("#tripDeleteUser").addClass("btn-default").removeClass("btn-danger"),$("#tripDeleteUser-"+t).parent().css("opacity","0.2"),$("#tripDeleteUser-"+t).text("Deleted"),o=!1}).error(function(){console.log("Something went wrong during delete tripCurrentUser")}))},t.userToGet={},t.tripCheckUser=function(){n.post("Users/getUserFromEmail.json",t.userToGet).success(function(e){var n=$(".modal.fade.in #tripId").first().text();e.user?t.tripAddUser(n,e.user.id):$(".modal.fade.in .form-message").text("User does not exist. Please try another email address."),t.userToGet={}}).error(function(){console.log("Something went wrong during save tripUserToAdd")})},t.tripAddUser=function(e,o){t.tripUserToAdd={trip_id:e,user_id:o},t.currentUserId!=o?n.post("TripsUsers/add.json",t.tripUserToAdd).success(function(){$(".modal.fade.in .form-message").text("This user has been added to the current trip"),t.getTripUsers(e),t.tripUserToAdd={}}).error(function(){console.log("Something went wrong during add trip for User "+id)}):$(".modal.fade.in .form-message").text("You already are part of the trip... ")}}),as.controller("ActionCtrl",function(t,e,n){t.addAction=function(e){if(!$("ul#type-id li.active").val())return $("html, body").animate({scrollTop:$("#chooseType").offset().top-120},"slow",function(){$("#chooseType").addClass("alert alert-danger")}),!1;if($("#chooseType").removeClass("alert alert-danger"),!$("#name").val())return $("html, body").animate({scrollTop:$("#name").offset().top-120},"slow",function(){$("#name").parents(".form-group").addClass("has-error alert alert-danger")}),!1;$("#name").parents(".form-group").removeClass("alert alert-danger");var o=[];$("#participants input[type='checkbox']:checked").each(function(){o.push($(this).attr("data-id"))});var a="",i="";$("#start_time").val()?a=" "+$("#start_time").val()+":00":$("#start_date").val()&&(a=" 12:00:01"),$("#end_time").val()?i=" "+$("#end_time").val()+":00":$("#end_date").val()&&(i=" 12:00:01"),t.action.status=1,t.action.type_id=$("ul#type-id li.active").val(),t.action.start_date=$("#start_date").val()+a,!$("#end_date").val()&&$("#end_time").val()?t.action.end_date=$("#start_date").val()+i:t.action.end_date=$("#end_date").val()+i,t.action.start_name=$("#start-name").val(),t.action.start_lng=$("#start-lng").val(),t.action.start_lat=$("#start-lat").val(),t.action.end_name=$("#end-name").val(),t.action.end_lng=$("#end-lng").val(),t.action.end_lat=$("#end-lat").val(),t.action.currency=$("#actionCurrency").text(),$("#action-status").text()?t.action.status=$("#action-status").text():t.action.price?t.action.status=2:t.action.status=1,t.action.action_users=o,n.post("Actions/add/"+e,t.action).success(function(){document.location="actions/plan/"+e}).error(function(){console.log("Something went wrong during add Action")})},t.editAction=function(e,o){if(!$("#name").val())return $("html, body").animate({scrollTop:$("#name").offset().top-120},"slow",function(){$("#name").parents(".form-group").addClass("has-error")}),!1;$("#participants input:not(.isParticipating):checked").each(function(){var n=this.checked?$(this).val():"";t.actionAddUser(e,o,n)}),$("#participants input:not(:checked).isParticipating").each(function(){var e=$(this).attr("data-participant");t.actionDeleteUser(e)});var a="",i="";$("#start_time").val()?a=" "+$("#start_time").val()+":00":$("#start_date").val()&&(a=" 12:00:01"),$("#end_time").val()?i=" "+$("#end_time").val()+":00":$("#end_date").val()&&(i=" 12:00:01"),t.action.type_id=$("ul#type-id li.active").val(),t.action.start_date=$("#start_date").val()+a,!$("#end_date").val()&&$("#end_time").val()?t.action.end_date=$("#start_date").val()+i:t.action.end_date=$("#end_date").val()+i,t.action.start_name=$("#start-name").val(),t.action.start_lng=$("#start-lng").val(),t.action.start_lat=$("#start-lat").val(),t.action.end_name=$("#end-name").val(),t.action.end_lng=$("#end-lng").val(),t.action.end_lat=$("#end-lat").val(),t.action.currency=$("#actionCurrency").text(),t.action.trip="",t.action.type="",t.action.users="",t.action.payments="",n.post("Actions/edit/"+o,t.action).success(function(){t.actionListPayments(o).then(function(){document.location="actions/plan/"+e})}).error(function(){console.log("Something went wrong during edit Action")})},t.deleteAction=function(t,e){n["delete"]("Actions/delete/"+e).success(function(){document.location="actions/plan/"+t}).error(function(){console.log("Something went wrong during delete Action")})},t.actionDeleteUser=function(t){n["delete"]("actions-users/delete/"+t).success(function(){}).error(function(){console.log("Something went wrong during delete action for User "+t)})},t.actionAddUser=function(e,o,a){t.actionUserToAdd={action_id:o,user_id:a},n.post("actions-users/add.json",t.actionUserToAdd).success(function(){t.actionUserToAdd={}}).error(function(){console.log("Something went wrong during add action for User "+a)})},t.selectAllUsers=function(){$("#participants input").prop("checked",!0)},t.selectOnlyMe=function(){$("#participants label:not(.hidden) input").prop("checked",!1)},t.actionListPayments=function(e){return n.get("actions/view/"+e+".json").success(function(n){t.action=n.action,t.action.payments.totalAll=0,t.action.payments.totalAuth=0,t.action.payments.forEach(function(e){e.user_id==t.currentUserId&&(t.action.payments.totalAuth+=e.amount),t.action.payments.totalAll+=e.amount}),t.updateStatus(e)}).error(function(){console.log("Something went wrong during load Payments")})},t.updateStatus=function(e){t.action.status=0,0===t.action.payments.totalAll?t.action.status=2:t.action.payments.totalAll==t.action.price?t.action.status=4:t.action.payments.totalAll>t.action.price||!t.action.price?t.action.status=5:t.action.status=3,null===t.action.price&&(t.action.status=1),t.actionStatusUpdate={status:t.action.status},e&&n.post("actions/edit/"+e+".json",t.actionStatusUpdate).success(function(){t.actionStatusUpdate={}}).error(function(){console.log("Something went wrong during update status")})},t.actionDeletePayment=function(e,o){n["delete"]("Payments/delete/"+e+".json").success(function(){t.actionListPayments(o)}).error(function(){console.log("Something went wrong during delete payment")})};var o=[];t.actionPaymentToAdd={};var a=0;t.actionAddTempPayment=function(e){t.actionPaymentToAdd.currency=$("#paymentCurrency").text(),$("#datePayment").val()&&(t.actionPaymentToAdd.date=$("#datePayment").val()+" 12:00:00");var n={user_id:e,amount:t.actionPaymentToAdd.amount,currency:t.actionPaymentToAdd.currency,method_id:t.actionPaymentToAdd.method_id,date:t.actionPaymentToAdd.date};a+=Number(t.actionPaymentToAdd.amount),o.push(n),t.action.payments=o,t.action.payments.totalAll=a,t.updateStatus()},t.actionAddPayment=function(e,o){t.actionPaymentToAdd={},t.actionPaymentToAdd.amount=$("#paymentAmount").val(),t.actionPaymentToAdd.currency=$("#paymentCurrency").text(),$("#datePayment").val()&&(t.actionPaymentToAdd.date=$("#datePayment").val()+" 12:00:00"),t.actionPaymentToAdd.method_id=$("#method_id :selected").val(),t.actionPaymentToAdd.action_id=e,t.actionPaymentToAdd.user_id=o,n.post("Payments/add.json",t.actionPaymentToAdd).success(function(){t.actionPaymentToAdd={},t.actionListPayments(e)}).error(function(){console.log("Something went wrong during add payment to action "+e)})},t.actionPayAll=function(e,o){t.actionPaymentToAdd.amount=t.action.price,t.actionPaymentToAdd.currency=t.action.currency;var a=(new Date).toISOString().slice(0,10)+" 12:00:00";t.actionPaymentToAdd.date=a,t.actionPaymentToAdd.action_id=e,t.actionPaymentToAdd.user_id=o,n.post("Payments/add.json",t.actionPaymentToAdd).success(function(){t.actionPaymentToAdd={},t.actionListPayments(e)}).error(function(){console.log("Something went wrong during add payment to action "+e)})},t.actionPaymentToEdit={},t.actionSavePayment=function(e,n,o){o?t.actionUpdatePayment(e,o):(t.action.payments={},t.actionAddPayment(e,n))},t.actionEditPayment=function(e){t.totalPaid=$("#totalPaid").text(),e?n.get("Payments/view/"+e+".json").success(function(n){t.actionPaymentToAdd=n.payment,t.actionPaymentToAdd.payment_id=e}).error(function(){console.log("Something went wrong Edit Payment")}):(t.actionPaymentToAdd={},t.actionPaymentToAdd.amount=t.action.price-t.totalPaid)},t.actionUpdatePayment=function(e,o){t.actionPaymentToAdd.user="",t.actionPaymentToAdd.action="",t.actionPaymentToAdd.payment_id="",t.actionPaymentToAdd.method="",t.actionPaymentToAdd.method_id=$("#method_id option:selected").val(),t.actionPaymentToAdd.currency=$("#paymentCurrency").text(),$("#datePayment").val()&&(t.actionPaymentToAdd.date=$("#datePayment").val()+" 12:00:00"),n.post("Payments/edit/"+o,t.actionPaymentToAdd).success(function(){t.actionListPayments(e),t.updateStatus()}).error(function(){console.log("Something went wrong during update Payment")})}});