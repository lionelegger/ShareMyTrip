as=angular.module("myApp",["ngRoute"]),as.controller("MainCtrl",function(t,n,e,a){t.getCurrentUser=function(){n.get("users/current.json").success(function(n){void 0!==n.user&&(t.currentUserId=n.user.id,t.currentUserEmail=n.user.email,t.currentUserPassword=n.user.password,t.currentUserFirstname=n.user.first_name,t.currentUserLastname=n.user.last_name)}).error(function(){t.currentUserId="user undefined"})},t.getCurrentUser(),t.logout=function(){n.get("Users/logout")},t.userToAdd={},t.addUser=function(){n.post("Users/add",t.userToAdd).success(function(){t.userToAdd={},document.location="trips"}).error(function(){console.log("Something went wrong during user registration")})}}),as.controller("TripsCtrl",function(t,n,e){t.loadTrips=function(){e.get("trips.json").success(function(n){t.trips=n.trips,$(".modal-backdrop").hide()}).error(function(){console.log("Something went wrong during load Trips")})},t.loadTrips(),t.loadTrip=function(n){e.get("trips/"+n+".json").success(function(n){t.trip=n.trip}).error(function(){console.log("Something went wrong during load Trip")})},t.addTrip=function(){t.tripToAdd={},t.welcomeMsg=!1,t.tripToAdd.name=$("#add_tripName").val(),$("#add_date_start").val()&&(t.tripToAdd.date_start=$("#add_date_start").val()+" 12:00:00"),$("#add_date_end").val()&&(t.tripToAdd.date_end=$("#add_date_end").val()+" 12:00:00"),t.tripToAdd.currency=$("#add_currency option:selected").val(),e.post("Trips/add.json",t.tripToAdd).success(function(n){t.tripToAdd={},t.loadTrips()}).error(function(){console.log("Something went wrong during add Trip")})},t.editTrip=function(n){t.btnPressed=!1,t.buttonTxt="Delete",$(".modal .form-message").empty(),n?t.loadTrip(n):(t.trip={},t.trips.trip={})},t.editParticipants=function(n){t.loadTrip(n),t.getTripUsers(n)},t.saveTrip=function(n){t.trip.date_start=$("#date_start").val(),t.trip.date_end=$("#date_end").val(),t.trip.currency=$("#currency option:selected").val(),e.post("Trips/edit/"+n,t.trip).success(function(){t.loadTrips()}).error(function(){console.log("Something went wrong during save Trip")})},t.buttonTxt="Delete",t.deleteConfirm=function(n){t.btnPressed?(t.btnPressed=!1,$("#tripEdit").modal("toggle"),t.deleteTrip(n),t.buttonTxt="Delete trip"):(t.btnPressed=!0,t.buttonTxt="Are you sure?")},t.deleteTrip=function(n){e["delete"]("Trips/delete/"+n).success(function(){t.loadTrips()}).error(function(){console.log("Something went wrong during save Trip")})},t.getTripUsers=function(n){e.get("trips/"+n+".json").success(function(n){t.trips.trip=n.trip}).error(function(){console.log("Something went wrong during load Trip")})},t.tripDeleteUser=function(t){e["delete"]("TripsUsers/delete/"+t+".json").success(function(){$("#tripDeleteUser").addClass("btn-default").removeClass("btn-danger"),$("#tripDeleteUser-"+t).parent().css("opacity","0.2"),$("#tripDeleteUser-"+t).text("Deleted")}).error(function(){console.log("Something went wrong during delete tripCurrentUser")})},t.userToGet={},t.tripCheckUser=function(){e.post("Users/getUserFromEmail.json",t.userToGet).success(function(n){var e=$(".modal.fade.in #tripId").first().text();n.user?t.tripAddUser(e,n.user.id):$(".modal.fade.in .form-message").text("User does not exist. Please try another email address."),t.userToGet={}}).error(function(){console.log("Something went wrong during save tripUserToAdd")})},t.tripAddUser=function(n,a){t.tripUserToAdd={trip_id:n,user_id:a},t.currentUserId!=a?e.post("TripsUsers/add.json",t.tripUserToAdd).success(function(){$(".modal.fade.in .form-message").text("This user has been added to the current trip"),t.getTripUsers(n),t.tripUserToAdd={}}).error(function(){console.log("Something went wrong during add trip for User "+id)}):$(".modal.fade.in .form-message").text("You already are part of the trip... ")}}),as.controller("ActionCtrl",function(t,n,e){t.addAction=function(n){if(!$("ul#type-id li.active").val())return $("html, body").animate({scrollTop:$("#chooseType").offset().top-120},"slow",function(){$("#chooseType").addClass("alert alert-danger")}),!1;if($("#chooseType").removeClass("alert alert-danger"),!$("#name").val())return $("html, body").animate({scrollTop:$("#name").offset().top-120},"slow",function(){$("#name").parents(".form-group").addClass("has-error alert alert-danger")}),!1;$("#name").parents(".form-group").removeClass("alert alert-danger");var a=[];$("#participants input[type='checkbox']:checked").each(function(){a.push($(this).attr("data-id"))});var o="",i="";$("#start_time").val()?o=" "+$("#start_time").val()+":00":$("#start_date").val()&&(o=" 12:00:01"),$("#end_time").val()?i=" "+$("#end_time").val()+":00":$("#end_date").val()&&(i=" 12:00:01"),t.action.status=1,t.action.type_id=$("ul#type-id li.active").val(),t.action.start_date=$("#start_date").val()+o,!$("#end_date").val()&&$("#end_time").val()?t.action.end_date=$("#start_date").val()+i:t.action.end_date=$("#end_date").val()+i,t.action.start_name=$("#start-name").val(),t.action.start_lng=$("#start-lng").val(),t.action.start_lat=$("#start-lat").val(),t.action.end_name=$("#end-name").val(),t.action.end_lng=$("#end-lng").val(),t.action.end_lat=$("#end-lat").val(),t.action.currency=$("#actionCurrency").text(),$("#action-status").text()?t.action.status=$("#action-status").text():t.action.price?t.action.status=2:t.action.status=1,t.action.action_users=a,e.post("Actions/add/"+n,t.action).success(function(){document.location="actions/plan/"+n}).error(function(){console.log("Something went wrong during add Action")})},t.editAction=function(n,a){if(!$("#name").val())return $("html, body").animate({scrollTop:$("#name").offset().top-120},"slow",function(){$("#name").parents(".form-group").addClass("has-error")}),!1;$("#participants input:not(.isParticipating):checked").each(function(){var e=this.checked?$(this).val():"";t.actionAddUser(n,a,e)}),$("#participants input:not(:checked).isParticipating").each(function(){var n=$(this).attr("data-participant");t.actionDeleteUser(n)});var o="",i="";$("#start_time").val()?o=" "+$("#start_time").val()+":00":$("#start_date").val()&&(o=" 12:00:01"),$("#end_time").val()?i=" "+$("#end_time").val()+":00":$("#end_date").val()&&(i=" 12:00:01"),t.action.type_id=$("ul#type-id li.active").val(),t.action.start_date=$("#start_date").val()+o,!$("#end_date").val()&&$("#end_time").val()?t.action.end_date=$("#start_date").val()+i:t.action.end_date=$("#end_date").val()+i,t.action.start_name=$("#start-name").val(),t.action.start_lng=$("#start-lng").val(),t.action.start_lat=$("#start-lat").val(),t.action.end_name=$("#end-name").val(),t.action.end_lng=$("#end-lng").val(),t.action.end_lat=$("#end-lat").val(),t.action.currency=$("#actionCurrency").text(),t.action.trip="",t.action.type="",t.action.users="",t.action.payments="",e.post("Actions/edit/"+a,t.action).success(function(){t.actionListPayments(a).then(function(){document.location="actions/plan/"+n})}).error(function(){console.log("Something went wrong during edit Action")})},t.deleteAction=function(t,n){e["delete"]("Actions/delete/"+n).success(function(){document.location="actions/plan/"+t}).error(function(){console.log("Something went wrong during delete Action")})},t.actionDeleteUser=function(t){e["delete"]("actions-users/delete/"+t).success(function(){}).error(function(){console.log("Something went wrong during delete action for User "+t)})},t.actionAddUser=function(n,a,o){t.actionUserToAdd={action_id:a,user_id:o},e.post("actions-users/add.json",t.actionUserToAdd).success(function(){t.actionUserToAdd={}}).error(function(){console.log("Something went wrong during add action for User "+o)})},t.selectAllUsers=function(){$("#participants input").prop("checked",!0)},t.selectOnlyMe=function(){$("#participants label:not(.hidden) input").prop("checked",!1)},t.actionListPayments=function(n){return e.get("actions/view/"+n+".json").success(function(e){t.action=e.action,t.action.payments.totalAll=0,t.action.payments.totalAuth=0,t.action.payments.forEach(function(n){n.user_id==t.currentUserId&&(t.action.payments.totalAuth+=n.amount),t.action.payments.totalAll+=n.amount}),t.updateStatus(n)}).error(function(){console.log("Something went wrong during load Payments")})},t.updateStatus=function(n){t.action.status=0,0===t.action.payments.totalAll?t.action.status=2:t.action.payments.totalAll==t.action.price?t.action.status=4:t.action.payments.totalAll>t.action.price?t.action.status=5:t.action.status=3,null===t.action.price&&(t.action.status=1),t.actionStatusUpdate={status:t.action.status},n&&e.post("actions/edit/"+n+".json",t.actionStatusUpdate).success(function(){t.actionStatusUpdate={}}).error(function(){console.log("Something went wrong during update status")})},t.actionDeletePayment=function(n,a){e["delete"]("Payments/delete/"+n+".json").success(function(){t.actionListPayments(a)}).error(function(){console.log("Something went wrong during delete payment")})};var a=[];t.actionPaymentToAdd={};var o=0;t.actionAddTempPayment=function(n){t.actionPaymentToAdd.currency=$("#paymentCurrency").text(),$("#datePayment").val()&&(t.actionPaymentToAdd.date=$("#datePayment").val()+" 12:00:00");var e={user_id:n,amount:t.actionPaymentToAdd.amount,currency:t.actionPaymentToAdd.currency,method_id:t.actionPaymentToAdd.method_id,date:t.actionPaymentToAdd.date};o+=Number(t.actionPaymentToAdd.amount),a.push(e),t.action.payments=a,t.action.payments.totalAll=o,t.updateStatus()},t.actionAddPayment=function(n,a){t.actionPaymentToAdd={},t.actionPaymentToAdd.amount=$("#paymentAmount").val(),t.actionPaymentToAdd.currency=$("#paymentCurrency").text(),$("#datePayment").val()&&(t.actionPaymentToAdd.date=$("#datePayment").val()+" 12:00:00"),t.actionPaymentToAdd.method_id=$("#method_id :selected").val(),t.actionPaymentToAdd.action_id=n,t.actionPaymentToAdd.user_id=a,e.post("Payments/add.json",t.actionPaymentToAdd).success(function(){t.actionPaymentToAdd={},t.actionListPayments(n)}).error(function(){console.log("Something went wrong during add payment to action "+n)})},t.actionPayAll=function(n,a){t.actionPaymentToAdd.amount=t.action.price,t.actionPaymentToAdd.currency=t.action.currency;var o=(new Date).toISOString().slice(0,10)+" 12:00:00";t.actionPaymentToAdd.date=o,t.actionPaymentToAdd.action_id=n,t.actionPaymentToAdd.user_id=a,e.post("Payments/add.json",t.actionPaymentToAdd).success(function(){t.actionPaymentToAdd={},t.actionListPayments(n)}).error(function(){console.log("Something went wrong during add payment to action "+n)})},t.actionPaymentToEdit={},t.actionSavePayment=function(n,e,a){a?t.actionUpdatePayment(n,a):(t.action.payments={},t.actionAddPayment(n,e))},t.actionEditPayment=function(n){n?e.get("Payments/view/"+n+".json").success(function(e){t.actionPaymentToAdd=e.payment,t.actionPaymentToAdd.payment_id=n}).error(function(){console.log("Something went wrong Edit Payment")}):t.actionPaymentToAdd={}},t.actionUpdatePayment=function(n,a){t.actionPaymentToAdd.user="",t.actionPaymentToAdd.action="",t.actionPaymentToAdd.payment_id="",t.actionPaymentToAdd.method="",t.actionPaymentToAdd.method_id=$("#method_id option:selected").val(),t.actionPaymentToAdd.currency=$("#paymentCurrency").text(),$("#datePayment").val()&&(t.actionPaymentToAdd.date=$("#datePayment").val()+" 12:00:00"),e.post("Payments/edit/"+a,t.actionPaymentToAdd).success(function(){t.actionListPayments(n),t.updateStatus()}).error(function(){console.log("Something went wrong during update Payment")})}});