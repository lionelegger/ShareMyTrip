as.controller("MainCtrl",function(t,o,n,e){console.log("call MainCtrl"),o.get("users/current.json").success(function(o){void 0!==o.user&&(t.currentUserId=o.user.id,t.currentUserEmail=o.user.email,t.currentUserFirstname=o.user.first_name,t.currentUserLastname=o.user.last_name)}).error(function(o){t.currentUserId="user undefined"}),t.logout=function(){o.get("Users/logout"),console.log("call logout")},t.newUserToAdd={},t.addNewUser=function(){o.post("Users/add",t.newUserToAdd).success(function(){console.log(t.newUserToAdd),t.newUserToAdd={},e.location.reload()}).error(function(){console.log(t.newUserToAdd),console.log("Something went wrong during user registration")})}}),as.controller("TripsCtrl",function(t,o,n){console.log("call TripsCtrl"),t.loadTrips=function(){console.log("call loadTrips"),n.get("trips.json").success(function(o){t.trips=o.trips,console.log(t.trips),$(".modal-backdrop").hide()}).error(function(){console.log("Something went wrong during load Trips")})},t.loadTrips(),t.loadTrip=function(o){console.log("call loadTrip"),n.get("trips/"+o+".json").success(function(o){t.trip=o.trip,console.log(t.trip)}).error(function(){console.log("Something went wrong during load Trip")})},t.addTrip=function(){console.log("call addTrip"),n.post("Trips/add.json",t.trip).success(function(o){console.log(o.trip),t.trip=o.trip,console.log("Trip "+o.trip.id+" added..."),t.getTripUsers(o.trip.id)}).error(function(){console.log("Something went wrong during add Trip")})},t.editTrip=function(o){console.log("call editTrip with trip "+o),$(".modal .form-message").empty(),o>0?($("#collapseParticipation").collapse("show"),t.loadTrip(o),t.getTripUsers(o)):(t.trip={},t.trips.trip={},$("#collapseParticipation").collapse("hide"))},t.saveTrip=function(o){console.log("call saveTrip with trip "+o),n.post("Trips/edit/"+o,t.trip).success(function(){console.log("trip "+o+" saved!"),t.loadTrips()}).error(function(){console.log("Something went wrong during save Trip")})},t.deleteTrip=function(o){n["delete"]("Trips/delete/"+o).success(function(){console.log("Delete trip "+o),t.loadTrips()}).error(function(){console.log("Something went wrong during save Trip")})},t.getTripUsers=function(o){console.log("call getTripUsers"),n.get("trips/"+o+".json").success(function(o){console.log(o),t.trips.trip=o.trip,console.log("trip users refreshed")}).error(function(){console.log("Something went wrong during load Trip")})},t.tripDeleteUser=function(t){console.log("call tripDeleteUser for user "+t),n["delete"]("TripsUsers/delete/"+t+".json").success(function(){$("#tripDeleteUser").addClass("btn-default").removeClass("btn-danger"),$("#tripDeleteUser-"+t).parent().css("opacity","0.2"),$("#tripDeleteUser-"+t).text("Deleted")}).error(function(){console.log("Something went wrong during delete tripCurrentUser")})},t.userToGet={},t.tripCheckUser=function(){console.log("call tripAddUser"),n.post("Users/getUserFromEmail.json",t.userToGet).success(function(o){console.log("data sent: "+t.userToGet.email),console.log(o.user);var n=$(".modal.fade.in #tripId").first().text();o.user?t.tripAddUser(n,o.user.id):$(".modal.fade.in .form-message").text("User does not exist. Please try another email address."),t.userToGet={}}).error(function(){console.log("Something went wrong during save tripUserToAdd")})},t.tripAddUser=function(o,e){t.tripUserToAdd={trip_id:o,user_id:e},t.currentUserId!=e?(console.log("call tripAddUser for user "+e+" and trip "+o),n.post("TripsUsers/add.json",t.tripUserToAdd).success(function(){$(".modal.fade.in .form-message").text("This user has been added to the current trip"),t.getTripUsers(o),t.tripUserToAdd={}}).error(function(){console.log("Something went wrong during add trip for User "+id)})):$(".modal.fade.in .form-message").text("You already are part of the trip... ")}}),as.controller("ActionCtrl",function(t,o,n){console.log("call ActionCtrl"),t.addAction=function(o){console.log("call addAction");var e=[];$("#participants input[type='checkbox']:checked").each(function(){e.push($(this).attr("data-id"))});var i="",a="";$("#start_time").val()?i=" "+$("#start_time").val()+":00":$("#start_date").val()&&(i=" 00:00:00"),$("#end_time").val()?a=" "+$("#end_time").val()+":00":$("#end_date").val()&&(a=" 00:00:00"),t.action.status=1,t.action.type_id=$("ul#type-id li.active").val(),t.action.start_date=$("#start_date").val()+i,t.action.end_date=$("#end_date").val()+a,t.action.start_name=$("#start-name").val(),t.action.start_lng=$("#start-lng").val(),t.action.start_lat=$("#start-lat").val(),t.action.end_name=$("#end-name").val(),t.action.end_lng=$("#end-lng").val(),t.action.end_lat=$("#end-lat").val(),t.action.currency=$("#actionCurrency").text(),t.action.action_users=e,n.post("Actions/add/"+o,t.action).success(function(){console.log(t.action),console.log("Action "+t.action.name+" added..."),document.location="actions/plan/"+o}).error(function(){console.log("Something went wrong during add Action")})},t.editAction=function(o,e){console.log("call editAction for action "+e+" and trip "+o),$("#participants input:not(.isParticipating):checked").each(function(){var n=this.checked?$(this).val():"";console.log("It will add participation_id = "+n),t.actionAddUser(o,e,n)}),$("#participants input:not(:checked).isParticipating").each(function(){var o=$(this).attr("data-participant");console.log("It will delete participation_id = "+o),t.actionDeleteUser(o)});var i="",a="";$("#start_time").val()?i=" "+$("#start_time").val()+":00":$("#start_date").val()&&(i=" 00:00:00"),$("#end_time").val()?a=" "+$("#end_time").val()+":00":$("#end_date").val()&&(a=" 00:00:00"),t.action.type_id=$("ul#type-id li.active").val(),t.action.start_date=$("#start_date").val()+i,t.action.end_date=$("#end_date").val()+a,t.action.start_name=$("#start-name").val(),t.action.start_lng=$("#start-lng").val(),t.action.start_lat=$("#start-lat").val(),t.action.end_name=$("#end-name").val(),t.action.end_lng=$("#end-lng").val(),t.action.end_lat=$("#end-lat").val(),t.action.currency=$("#actionCurrency").text(),t.action.trip="",t.action.type="",t.action.users="",t.action.payments="",console.log("----"),console.log(t.action.users),n.post("Actions/edit/"+e,t.action).success(function(){console.log(t.action),console.log("Action "+e+" saved!"),document.location="actions/plan/"+o}).error(function(){console.log("Something went wrong during edit Action")})},t.deleteAction=function(t,o){n["delete"]("Actions/delete/"+o).success(function(){console.log("Delete Action "+o),document.location="actions/plan/"+t}).error(function(){console.log("Something went wrong during delete Action")})},t.actionDeleteUser=function(t){console.log("call deleteActionUser for: user "+t),n["delete"]("actions-users/delete/"+t).success(function(){console.log("Participant "+t+" has been removed!")}).error(function(){console.log("Something went wrong during delete action for User "+t)})},t.actionAddUser=function(o,e,i){console.log("call actionAddUser for: user "+i+", action "+e+", trip "+o),t.actionUserToAdd={action_id:e,user_id:i},n.post("actions-users/add.json",t.actionUserToAdd).success(function(){t.actionUserToAdd={}}).error(function(){console.log("Something went wrong during add action for User "+i)})},t.actionDeleteAllUsers=function(o){console.log("call actionDeleteAllUsers for action "+o),n.get("actions/view/"+o+".json").success(function(e){t.actions.action.users.forEach(function(e){e.id!=t.currentUserId?($deleteId=$("#user-"+e.id).attr("deleteId"),n["delete"]("actions-users/delete/"+$deleteId+".json").success(function(){t.actionListParticipants(t.actions.action.trip.id,o),$("#user-"+$userId).removeClass("btn-success"),console.log("Participant has been removed!")}).error(function(){console.log("Something went wrong during add action for User "+id)})):$("#user-"+$userId+" span.glyphicon.glyphicon-ok").remove()})}).error(function(){console.log("Something went wrong during add all users for the current action")})},t.selectAllUsers=function(){console.log("Select all users as participants..."),$("#participants input").prop("checked",!0)},t.selectOnlyMe=function(){console.log("Deselect all users except me..."),$("#participants label:not(.hidden) input").prop("checked",!1)},t.actionAddAllUsers=function(o){console.log("call actionAddAllUsers for action "+o),n.get("actions/view/"+o+".json").success(function(e){t.actions.action.trip.users.forEach(function(e){e.id!=t.currentUserId&&(t.actionUserToAdd={action_id:o,user_id:e.id},n.post("actions-users/add.json",t.actionUserToAdd).success(function(){t.actionUserToAdd={},t.actionListParticipants(t.actions.action.trip.id,o)}).error(function(){console.log("Something went wrong during add action for User "+id)}))})}).error(function(){console.log("Something went wrong during add all users for the current action")})},t.actionListParticipants=function(o,e){console.log("call actionListParticipants for action "+e+" and trip "+o),n.get("trips/"+o+".json").success(function(o){console.log(o),t.trips=o,n.get("actions/view/"+e+".json").success(function(o){console.log(o),t.actions=o,t.actions.action.users.forEach(function(t){$userId=t._joinData.user_id,$deleteId=t._joinData.id,console.log("Participant id = "+$userId),$("#user-"+$userId).addClass("btn-success").attr("deleteId",$deleteId)})}).error(function(){console.log("Something went wrong during load Action")})}).error(function(){console.log("Something went wrong during load Trip")})},t.actionListPayments=function(o){console.log("call actionListPayments for action "+o),n.get("actions/view/"+o+".json").success(function(n){console.log(n),t.action=n.action,t.action.payments.totalAll=0,t.action.payments.totalAuth=0,t.action.payments.forEach(function(o){o.user_id==t.currentUserId&&(t.action.payments.totalAuth+=o.amount),t.action.payments.totalAll+=o.amount}),t.updateStatus(o)}).error(function(){console.log("Something went wrong during load Payments")})},t.updateStatus=function(o){t.action.status=0,console.log("TOTAL = "+t.action.payments.totalAll),console.log("PRICE = "+t.action.price),0===t.action.payments.totalAll?t.action.status=2:t.action.payments.totalAll==t.action.price?t.action.status=4:t.action.payments.totalAll>t.action.price?t.action.status=5:t.action.status=3,null===t.action.price&&(t.action.status=1),t.actionStatusUpdate={status:t.action.status},o&&n.post("actions/edit/"+o+".json",t.actionStatusUpdate).success(function(){console.log("Status updated successfully"),t.actionStatusUpdate={}}).error(function(){console.log("Something went wrong during update status")})},t.actionDeletePayment=function(o,e){console.log("call actionDeletePayment for payment "+o),n["delete"]("Payments/delete/"+o+".json").success(function(){console.log("Payment deleted"),t.actionListPayments(e)}).error(function(){console.log("Something went wrong during delete payment")})};var e=[];t.actionPaymentToAdd={},t.actionAddTempPayment=function(o){console.log("call actionAddPayment for user "+o);var n={user_id:o,amount:t.actionPaymentToAdd.amount,currency:t.actionPaymentToAdd.currency,method_id:t.actionPaymentToAdd.method_id,date:t.actionPaymentToAdd.date};e.push(n),t.action.payments=e,console.log(t.action.payments),t.action.payments.totalAll=0,t.action.payments.forEach(function(o){t.action.payments.totalAll+=o.amount}),t.updateStatus()},t.actionPaymentToAdd={},t.actionAddPayment=function(o,e){t.actionPaymentToAdd.action_id=o,t.actionPaymentToAdd.user_id=e,console.log("call actionAddPayment for action "+o+" and user "+e),n.post("Payments/add.json",t.actionPaymentToAdd).success(function(){console.log(t.actionPaymentToAdd),t.actionPaymentToAdd={},t.actionListPayments(o)}).error(function(){console.log("Something went wrong during add payment to action "+o)})},t.actionPaymentToEdit={},t.actionSavePayment=function(o,n,e){console.log("call actionSavePayment with payment "+e),e?(console.log("UPDATE PAYMENT IN DB"),t.actionUpdatePayment(o,e)):(t.action.payments={},t.actionAddPayment(o,n))},t.actionEditPayment=function(o){console.log("call actionEditPayment for payment "+o),n.get("Payments/view/"+o+".json").success(function(n){t.actionPaymentToAdd=n.payment,t.actionPaymentToAdd.payment_id=o,console.log(t.actionPaymentToAdd)}).error(function(){console.log("Something went wrong Edit Payment")})},t.actionUpdatePayment=function(o,e){console.log("call actionUpdatePayment for payment "+e),t.actionPaymentToAdd.user="",t.actionPaymentToAdd.action="",t.actionPaymentToAdd.payment_id="",n.post("Payments/edit/"+e,t.actionPaymentToAdd).success(function(){console.log(t.actionPaymentToAdd),t.actionListPayments(o),t.updateStatus()}).error(function(){console.log("Something went wrong during update Payment")})}});