as=angular.module("myApp",["ngRoute"]),as.controller("MainCtrl",function(t,e,o,n){console.log("call MainCtrl"),t.getCurrentUser=function(){e.get("users/current.json").success(function(e){void 0!==e.user&&(t.currentUserId=e.user.id,t.currentUserEmail=e.user.email,t.currentUserPassword=e.user.password,t.currentUserFirstname=e.user.first_name,t.currentUserLastname=e.user.last_name)}).error(function(e){t.currentUserId="user undefined"})},t.getCurrentUser(),t.logout=function(){e.get("Users/logout"),console.log("call logout")},t.userToAdd={},t.addUser=function(){e.post("Users/add",t.userToAdd).success(function(){console.log(t.userToAdd),t.userToAdd={},document.location="trips"}).error(function(){console.log(t.userToAdd),console.log("Something went wrong during user registration")})},t.loadUser=function(){t.currentUser={},console.log("ID= "+t.currentUserId),t.currentUser.email=t.currentUserEmail,t.currentUser.first_name=t.currentUserFirstname,t.currentUser.last_name=t.currentUserLastname}}),as.controller("TripsCtrl",function(t,e,o){console.log("call TripsCtrl"),t.loadTrips=function(){console.log("call loadTrips"),o.get("trips.json").success(function(e){t.trips=e.trips,console.log(t.trips),$(".modal-backdrop").hide()}).error(function(){console.log("Something went wrong during load Trips")})},t.loadTrips(),t.loadTrip=function(e){console.log("call loadTrip"),o.get("trips/"+e+".json").success(function(e){t.trip=e.trip,console.log(t.trip)}).error(function(){console.log("Something went wrong during load Trip")})},t.addTrip=function(){console.log("call addTrip"),o.post("Trips/add.json",t.trip).success(function(e){console.log(e.trip),t.trip=e.trip,console.log("Trip "+e.trip.id+" added..."),t.getTripUsers(e.trip.id)}).error(function(){console.log("Something went wrong during add Trip")})},t.editTrip=function(e){t.btnPressed=!1,t.buttonTxt="Delete trip",console.log("call editTrip with trip "+e),$(".modal .form-message").empty(),e>0?($("#collapseParticipation").collapse("show"),t.loadTrip(e),t.getTripUsers(e)):(t.trip={},t.trips.trip={},$("#collapseParticipation").collapse("hide"))},t.saveTrip=function(e){console.log("call saveTrip with trip "+e),o.post("Trips/edit/"+e,t.trip).success(function(){console.log("trip "+e+" saved!"),t.loadTrips()}).error(function(){console.log("Something went wrong during save Trip")})},t.buttonTxt="Delete",t.deleteConfirm=function(e){t.btnPressed?(t.btnPressed=!1,$(".modal").modal("toggle"),t.deleteTrip(e),t.buttonTxt="Delete trip"):(t.btnPressed=!0,t.buttonTxt="Are you sure?")},t.deleteTrip=function(e){o["delete"]("Trips/delete/"+e).success(function(){console.log("Delete trip "+e),t.loadTrips()}).error(function(){console.log("Something went wrong during save Trip")})},t.getTripUsers=function(e){console.log("call getTripUsers"),o.get("trips/"+e+".json").success(function(e){console.log(e),t.trips.trip=e.trip,console.log("trip users refreshed")}).error(function(){console.log("Something went wrong during load Trip")})},t.tripDeleteUser=function(t){console.log("call tripDeleteUser for user "+t),o["delete"]("TripsUsers/delete/"+t+".json").success(function(){$("#tripDeleteUser").addClass("btn-default").removeClass("btn-danger"),$("#tripDeleteUser-"+t).parent().css("opacity","0.2"),$("#tripDeleteUser-"+t).text("Deleted")}).error(function(){console.log("Something went wrong during delete tripCurrentUser")})},t.userToGet={},t.tripCheckUser=function(){console.log("call tripAddUser"),o.post("Users/getUserFromEmail.json",t.userToGet).success(function(e){console.log("data sent: "+t.userToGet.email),console.log(e.user);var o=$(".modal.fade.in #tripId").first().text();e.user?t.tripAddUser(o,e.user.id):$(".modal.fade.in .form-message").text("User does not exist. Please try another email address."),t.userToGet={}}).error(function(){console.log("Something went wrong during save tripUserToAdd")})},t.tripAddUser=function(e,n){t.tripUserToAdd={trip_id:e,user_id:n},t.currentUserId!=n?(console.log("call tripAddUser for user "+n+" and trip "+e),o.post("TripsUsers/add.json",t.tripUserToAdd).success(function(){$(".modal.fade.in .form-message").text("This user has been added to the current trip"),t.getTripUsers(e),t.tripUserToAdd={}}).error(function(){console.log("Something went wrong during add trip for User "+id)})):$(".modal.fade.in .form-message").text("You already are part of the trip... ")}}),as.controller("ActionCtrl",function(t,e,o){console.log("call ActionCtrl"),t.addAction=function(e){console.log("call addAction");var n=[];$("#participants input[type='checkbox']:checked").each(function(){n.push($(this).attr("data-id"))});var a="",i="";$("#start_time").val()?a=" "+$("#start_time").val()+":00":$("#start_date").val()&&(a=" 12:00:01"),$("#end_time").val()?i=" "+$("#end_time").val()+":00":$("#end_date").val()&&(i=" 12:00:01"),t.action.status=1,t.action.type_id=$("ul#type-id li.active").val(),t.action.start_date=$("#start_date").val()+a,!$("#end_date").val()&&$("#end_time").val()?t.action.end_date=$("#start_date").val()+i:t.action.end_date=$("#end_date").val()+i,t.action.start_name=$("#start-name").val(),t.action.start_lng=$("#start-lng").val(),t.action.start_lat=$("#start-lat").val(),t.action.end_name=$("#end-name").val(),t.action.end_lng=$("#end-lng").val(),t.action.end_lat=$("#end-lat").val(),t.action.currency=$("#actionCurrency").text(),t.action.action_users=n,o.post("Actions/add/"+e,t.action).success(function(){console.log(t.action),console.log("Action "+t.action.name+" added..."),document.location="actions/plan/"+e}).error(function(){console.log("Something went wrong during add Action")})},t.editAction=function(e,n){console.log("call editAction for action "+n+" and trip "+e),$("#participants input:not(.isParticipating):checked").each(function(){var o=this.checked?$(this).val():"";console.log("It will add participation_id = "+o),t.actionAddUser(e,n,o)}),$("#participants input:not(:checked).isParticipating").each(function(){var e=$(this).attr("data-participant");console.log("It will delete participation_id = "+e),t.actionDeleteUser(e)});var a="",i="";$("#start_time").val()?a=" "+$("#start_time").val()+":00":$("#start_date").val()&&(a=" 12:00:01"),$("#end_time").val()?i=" "+$("#end_time").val()+":00":$("#end_date").val()&&(i=" 12:00:01"),t.action.type_id=$("ul#type-id li.active").val(),t.action.start_date=$("#start_date").val()+a,!$("#end_date").val()&&$("#end_time").val()?t.action.end_date=$("#start_date").val()+i:t.action.end_date=$("#end_date").val()+i,t.action.start_name=$("#start-name").val(),t.action.start_lng=$("#start-lng").val(),t.action.start_lat=$("#start-lat").val(),t.action.end_name=$("#end-name").val(),t.action.end_lng=$("#end-lng").val(),t.action.end_lat=$("#end-lat").val(),t.action.currency=$("#actionCurrency").text(),t.action.trip="",t.action.type="",t.action.users="",t.action.payments="",console.log("--ID--"),console.log(t.action.type_id),o.post("Actions/edit/"+n,t.action).success(function(){console.log(t.action),console.log("Action "+n+" saved!"),t.actionListPayments(n).then(function(){document.location="actions/plan/"+e})}).error(function(){console.log("Something went wrong during edit Action")})},t.deleteAction=function(t,e){o["delete"]("Actions/delete/"+e).success(function(){console.log("Delete Action "+e),document.location="actions/plan/"+t}).error(function(){console.log("Something went wrong during delete Action")})},t.actionDeleteUser=function(t){console.log("call deleteActionUser for: user "+t),o["delete"]("actions-users/delete/"+t).success(function(){console.log("Participant "+t+" has been removed!")}).error(function(){console.log("Something went wrong during delete action for User "+t)})},t.actionAddUser=function(e,n,a){console.log("call actionAddUser for: user "+a+", action "+n+", trip "+e),t.actionUserToAdd={action_id:n,user_id:a},o.post("actions-users/add.json",t.actionUserToAdd).success(function(){t.actionUserToAdd={}}).error(function(){console.log("Something went wrong during add action for User "+a)})},t.actionDeleteAllUsers=function(e){console.log("call actionDeleteAllUsers for action "+e),o.get("actions/view/"+e+".json").success(function(n){t.actions.action.users.forEach(function(n){n.id!=t.currentUserId?($deleteId=$("#user-"+n.id).attr("deleteId"),o["delete"]("actions-users/delete/"+$deleteId+".json").success(function(){t.actionListParticipants(t.actions.action.trip.id,e),$("#user-"+$userId).removeClass("btn-success"),console.log("Participant has been removed!")}).error(function(){console.log("Something went wrong during add action for User "+id)})):$("#user-"+$userId+" span.glyphicon.glyphicon-ok").remove()})}).error(function(){console.log("Something went wrong during add all users for the current action")})},t.selectAllUsers=function(){console.log("Select all users as participants..."),$("#participants input").prop("checked",!0)},t.selectOnlyMe=function(){console.log("Deselect all users except me..."),$("#participants label:not(.hidden) input").prop("checked",!1)},t.actionAddAllUsers=function(e){console.log("call actionAddAllUsers for action "+e),o.get("actions/view/"+e+".json").success(function(n){t.actions.action.trip.users.forEach(function(n){n.id!=t.currentUserId&&(t.actionUserToAdd={action_id:e,user_id:n.id},o.post("actions-users/add.json",t.actionUserToAdd).success(function(){t.actionUserToAdd={},t.actionListParticipants(t.actions.action.trip.id,e)}).error(function(){console.log("Something went wrong during add action for User "+id)}))})}).error(function(){console.log("Something went wrong during add all users for the current action")})},t.actionListParticipants=function(e,n){console.log("call actionListParticipants for action "+n+" and trip "+e),o.get("trips/"+e+".json").success(function(e){console.log(e),t.trips=e,o.get("actions/view/"+n+".json").success(function(e){console.log(e),t.actions=e,t.actions.action.users.forEach(function(t){$userId=t._joinData.user_id,$deleteId=t._joinData.id,console.log("Participant id = "+$userId),$("#user-"+$userId).addClass("btn-success").attr("deleteId",$deleteId)})}).error(function(){console.log("Something went wrong during load Action")})}).error(function(){console.log("Something went wrong during load Trip")})},t.actionListPayments=function(e){return console.log("call actionListPayments for action "+e),o.get("actions/view/"+e+".json").success(function(o){console.log(o),t.action=o.action,t.action.payments.totalAll=0,t.action.payments.totalAuth=0,t.action.payments.forEach(function(e){e.user_id==t.currentUserId&&(t.action.payments.totalAuth+=e.amount),t.action.payments.totalAll+=e.amount}),t.updateStatus(e)}).error(function(){console.log("Something went wrong during load Payments")})},t.updateStatus=function(e){t.action.status=0,console.log("TOTAL => "+t.action.payments.totalAll),console.log("PRICE => "+t.action.price),0===t.action.payments.totalAll?t.action.status=2:t.action.payments.totalAll==t.action.price?t.action.status=4:t.action.payments.totalAll>t.action.price?t.action.status=5:t.action.status=3,null===t.action.price&&(t.action.status=1),t.actionStatusUpdate={status:t.action.status},e&&o.post("actions/edit/"+e+".json",t.actionStatusUpdate).success(function(){console.log("Status updated successfully"),t.actionStatusUpdate={}}).error(function(){console.log("Something went wrong during update status")})},t.actionDeletePayment=function(e,n){console.log("call actionDeletePayment for payment "+e),o["delete"]("Payments/delete/"+e+".json").success(function(){console.log("Payment deleted"),t.actionListPayments(n)}).error(function(){console.log("Something went wrong during delete payment")})};var n=[];t.actionPaymentToAdd={},t.actionAddTempPayment=function(e){console.log("call actionAddPayment for user "+e);var o={user_id:e,amount:t.actionPaymentToAdd.amount,currency:t.actionPaymentToAdd.currency,method_id:t.actionPaymentToAdd.method_id,date:t.actionPaymentToAdd.date};n.push(o),t.action.payments=n,console.log(t.action.payments),t.action.payments.totalAll=0,t.action.payments.forEach(function(e){t.action.payments.totalAll+=e.amount}),t.updateStatus()},t.actionPaymentToAdd={},t.actionAddPayment=function(e,n){t.actionPaymentToAdd.currency=$("#paymentCurrency").text(),$("#datePayment").val()&&(t.actionPaymentToAdd.date=$("#datePayment").val()+" 12:00:00"),console.log("DATE="+t.actionPaymentToAdd.date),t.actionPaymentToAdd.action_id=e,t.actionPaymentToAdd.user_id=n,console.log("call actionAddPayment for action "+e+" and user "+n),o.post("Payments/add.json",t.actionPaymentToAdd).success(function(){console.log(t.actionPaymentToAdd),t.actionPaymentToAdd={},t.actionListPayments(e)}).error(function(){console.log("Something went wrong during add payment to action "+e)})},t.actionPaymentToEdit={},t.actionSavePayment=function(e,o,n){console.log("call actionSavePayment with payment "+n),n?(console.log("UPDATE PAYMENT IN DB"),t.actionUpdatePayment(e,n)):(t.action.payments={},t.actionAddPayment(e,o))},t.actionEditPayment=function(e){console.log("call actionEditPayment for payment "+e),o.get("Payments/view/"+e+".json").success(function(o){t.actionPaymentToAdd=o.payment,t.actionPaymentToAdd.payment_id=e,console.log(t.actionPaymentToAdd)}).error(function(){console.log("Something went wrong Edit Payment")})},t.actionUpdatePayment=function(e,n){console.log("call actionUpdatePayment for payment "+n),t.actionPaymentToAdd.user="",t.actionPaymentToAdd.action="",t.actionPaymentToAdd.payment_id="",t.actionPaymentToAdd.method="",t.actionPaymentToAdd.method_id=$("#method_id option:selected").val(),t.actionPaymentToAdd.currency=$("#paymentCurrency").text(),$("#datePayment").val()&&(t.actionPaymentToAdd.date=$("#datePayment").val()+" 12:00:00"),console.log("DATE="+t.actionPaymentToAdd.date),o.post("Payments/edit/"+n,t.actionPaymentToAdd).success(function(){console.log(t.actionPaymentToAdd),t.actionListPayments(e),t.updateStatus()}).error(function(){console.log("Something went wrong during update Payment")})}});